// üéì –ù–∞–≤—á–∞–ª—å–Ω–∏–π –∫–æ–º–µ–Ω—Ç–∞—Ä: –õ–∞—Å–∫–∞–≤–æ –ø—Ä–æ—Å–∏–º–æ –¥–æ –ü—Ä–∏–∫–ª–∞–¥—É 3 - HTTP –î–æ–≤–≥–µ –û–ø–∏—Ç—É–≤–∞–Ω–Ω—è!
// –¶–µ –∑–Ω–∞—á–Ω–µ –ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è –ø–æ—Ä—ñ–≤–Ω—è–Ω–æ –∑ –∫–æ—Ä–æ—Ç–∫–∏–º –æ–ø–∏—Ç—É–≤–∞–Ω–Ω—è–º. –ó–∞–º—ñ—Å—Ç—å —Ç–æ–≥–æ, —â–æ–± –∫–ª—ñ—î–Ω—Ç
// –ø–æ—Å—Ç—ñ–π–Ω–æ –ø–∏—Ç–∞–≤ "–Ñ –Ω–æ–≤—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è?", —Å–µ—Ä–≤–µ—Ä —Ç—Ä–∏–º–∞—î –∑–∞–ø–∏—Ç –≤—ñ–¥–∫—Ä–∏—Ç–∏–º,
// –¥–æ–∫–∏ –Ω–µ –∑'—è–≤–∏—Ç—å—Å—è —â–æ—Å—å –Ω–æ–≤–µ –¥–ª—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏.

const express = require('express');
const path = require('path');

// üîß –¢–µ—Ö–Ω—ñ—á–Ω–∏–π –∫–æ–º–µ–Ω—Ç–∞—Ä: –°—Ç–≤–æ—Ä—é—î–º–æ Express –¥–æ–¥–∞—Ç–æ–∫
const app = express();
const PORT = 3000;

// üîß –¢–µ—Ö–Ω—ñ—á–Ω–∏–π –∫–æ–º–µ–Ω—Ç–∞—Ä: –ó–±–µ—Ä—ñ–≥–∞–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å –≤ –ø–∞–º'—è—Ç—ñ
const messages = [];

// üéì –ù–∞–≤—á–∞–ª—å–Ω–∏–π –∫–æ–º–µ–Ω—Ç–∞—Ä: –ö–ª—é—á–æ–≤–∞ –≤—ñ–¥–º—ñ–Ω–Ω—ñ—Å—Ç—å - –º–∏ –∑–±–µ—Ä—ñ–≥–∞—î–º–æ –æ—á—ñ–∫—É—é—á–∏—Ö –∫–ª—ñ—î–Ω—Ç—ñ–≤!
// –û–±'—î–∫—Ç –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –∫–æ–∂–Ω–æ–≥–æ –∫–ª—ñ—î–Ω—Ç–∞ —É—Ç—Ä–∏–º—É—î—Ç—å—Å—è, –¥–æ–∫–∏ –Ω–µ –∑'—è–≤–ª—è—Ç—å—Å—è –Ω–æ–≤—ñ –¥–∞–Ω—ñ
const waitingClients = [];

// üîß –¢–µ—Ö–Ω—ñ—á–Ω–∏–π –∫–æ–º–µ–Ω—Ç–∞—Ä: –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è
const LONG_POLL_TIMEOUT = 30000; // 30 —Å–µ–∫—É–Ω–¥ —Ç–∞–π–º–∞—É—Ç

// üîß –¢–µ—Ö–Ω—ñ—á–Ω–∏–π –∫–æ–º–µ–Ω—Ç–∞—Ä: –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è middleware
app.use(express.json());
app.use(express.static(__dirname));

// üéì –ù–∞–≤—á–∞–ª—å–Ω–∏–π –∫–æ–º–µ–Ω—Ç–∞—Ä: –ó–≤–∏—á–∞–π–Ω–∏–π –µ–Ω–¥–ø–æ—ñ–Ω—Ç –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –ø–æ—á–∞—Ç–∫–æ–≤–∏—Ö –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å
app.get('/messages', (req, res) => {
    console.log(`üì• –ü–æ—á–∞—Ç–∫–æ–≤–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è - –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ ${messages.length} –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å`);
    res.json(messages);
});

// üéì –ù–∞–≤—á–∞–ª—å–Ω–∏–π –∫–æ–º–µ–Ω—Ç–∞—Ä: –¶–µ –º–∞–≥—ñ—è - –µ–Ω–¥–ø–æ—ñ–Ω—Ç –¥–æ–≤–≥–æ–≥–æ –æ–ø–∏—Ç—É–≤–∞–Ω–Ω—è!
// –°–µ—Ä–≤–µ—Ä —Ç—Ä–∏–º–∞—î —Ü–µ–π –∑–∞–ø–∏—Ç –≤—ñ–¥–∫—Ä–∏—Ç–∏–º, –¥–æ–∫–∏ –Ω–µ –ø—Ä–∏–π–¥—É—Ç—å –Ω–æ–≤—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
app.get('/subscribe', (req, res) => {
    // üîß –¢–µ—Ö–Ω—ñ—á–Ω–∏–π –∫–æ–º–µ–Ω—Ç–∞—Ä: –û—Ç—Ä–∏–º—É—î–º–æ ID –æ—Å—Ç–∞–Ω–Ω—å–æ–≥–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è, —è–∫–µ –º–∞—î –∫–ª—ñ—î–Ω—Ç
    const lastMessageId = parseInt(req.query.lastId) || 0;
    
    console.log(`üîå –ù–æ–≤–µ –¥–æ–≤–≥–µ –æ–ø–∏—Ç—É–≤–∞–Ω–Ω—è (–∫–ª—ñ—î–Ω—Ç –º–∞—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –¥–æ #${lastMessageId})`);
    
    // üéì –ù–∞–≤—á–∞–ª—å–Ω–∏–π –∫–æ–º–µ–Ω—Ç–∞—Ä: –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –≤–∂–µ —î –Ω–æ–≤—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
    const newMessages = messages.filter(msg => msg.id > lastMessageId);
    
    if (newMessages.length > 0) {
        // üîß –¢–µ—Ö–Ω—ñ—á–Ω–∏–π –∫–æ–º–µ–Ω—Ç–∞—Ä: –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –æ–¥—Ä–∞–∑—É, —è–∫—â–æ –º–∞—î–º–æ –Ω–æ–≤—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
        console.log(`üì§ –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ ${newMessages.length} –Ω–æ–≤–∏—Ö –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å –æ–¥—Ä–∞–∑—É`);
        return res.json(newMessages);
    }
    
    // üéì –ù–∞–≤—á–∞–ª—å–Ω–∏–π –∫–æ–º–µ–Ω—Ç–∞—Ä: –ù–µ–º–∞—î –Ω–æ–≤–∏—Ö –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å - —É—Ç—Ä–∏–º—É—î–º–æ —Ü–µ –∑'—î–¥–Ω–∞–Ω–Ω—è!
    // –¶–µ –∫–ª—é—á–æ–≤–∞ –≤—ñ–¥–º—ñ–Ω–Ω—ñ—Å—Ç—å –≤—ñ–¥ –∫–æ—Ä–æ—Ç–∫–æ–≥–æ –æ–ø–∏—Ç—É–≤–∞–Ω–Ω—è
    const client = {
        id: Date.now() + Math.random(), // –ü—Ä–æ—Å—Ç–∏–π —É–Ω—ñ–∫–∞–ª—å–Ω–∏–π ID
        response: res,
        lastMessageId: lastMessageId,
        timestamp: Date.now()
    };
    
    waitingClients.push(client);
    console.log(`‚è≥ –£—Ç—Ä–∏–º—É—î–º–æ –∑'—î–¥–Ω–∞–Ω–Ω—è - ${waitingClients.length} –∫–ª—ñ—î–Ω—Ç—ñ–≤ –æ—á—ñ–∫—É—é—Ç—å`);
    
    // üéì –ù–∞–≤—á–∞–ª—å–Ω–∏–π –∫–æ–º–µ–Ω—Ç–∞—Ä: –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ —Ç–∞–π–º–∞—É—Ç, —â–æ–± –∑–∞–ø–æ–±—ñ–≥—Ç–∏ –Ω–µ—Å–∫—ñ–Ω—á–µ–Ω–Ω–æ–º—É –æ—á—ñ–∫—É–≤–∞–Ω–Ω—é
    const timeout = setTimeout(() => {
        // üîß –¢–µ—Ö–Ω—ñ—á–Ω–∏–π –∫–æ–º–µ–Ω—Ç–∞—Ä: –í–∏–¥–∞–ª—è—î–º–æ —Ü—å–æ–≥–æ –∫–ª—ñ—î–Ω—Ç–∞ –∑—ñ —Å–ø–∏—Å–∫—É –æ—á—ñ–∫—É—é—á–∏—Ö
        const index = waitingClients.findIndex(c => c.id === client.id);
        if (index !== -1) {
            waitingClients.splice(index, 1);
            console.log(`‚è±Ô∏è –¢–∞–π–º–∞—É—Ç –¥–ª—è –∫–ª—ñ—î–Ω—Ç–∞ - ${waitingClients.length} –∫–ª—ñ—î–Ω—Ç—ñ–≤ –∑–∞–ª–∏—à–∏–ª–æ—Å—å`);
            
            // üîß –¢–µ—Ö–Ω—ñ—á–Ω–∏–π –∫–æ–º–µ–Ω—Ç–∞—Ä: –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –ø–æ—Ä–æ–∂–Ω—é –≤—ñ–¥–ø–æ–≤—ñ–¥—å –∑ 204 No Content
            res.status(204).end();
        }
    }, LONG_POLL_TIMEOUT);
    
    // üéì –ù–∞–≤—á–∞–ª—å–Ω–∏–π –∫–æ–º–µ–Ω—Ç–∞—Ä: –û—á–∏—â–∞—î–º–æ, —è–∫—â–æ –∫–ª—ñ—î–Ω—Ç –≤—ñ–¥'—î–¥–Ω–∞—î—Ç—å—Å—è
    req.on('close', () => {
        clearTimeout(timeout);
        const index = waitingClients.findIndex(c => c.id === client.id);
        if (index !== -1) {
            waitingClients.splice(index, 1);
            console.log(`üîå –ö–ª—ñ—î–Ω—Ç –≤—ñ–¥'—î–¥–Ω–∞–≤—Å—è - ${waitingClients.length} –∫–ª—ñ—î–Ω—Ç—ñ–≤ –∑–∞–ª–∏—à–∏–ª–æ—Å—å`);
        }
    });
});

// üéì –ù–∞–≤—á–∞–ª—å–Ω–∏–π –∫–æ–º–µ–Ω—Ç–∞—Ä: –ú–æ–¥–∏—Ñ—ñ–∫–æ–≤–∞–Ω–∏–π POST –µ–Ω–¥–ø–æ—ñ–Ω—Ç, —è–∫–∏–π —Å–ø–æ–≤—ñ—â–∞—î –æ—á—ñ–∫—É—é—á–∏—Ö –∫–ª—ñ—î–Ω—Ç—ñ–≤
app.post('/messages', (req, res) => {
    const { user, text } = req.body;
    
    // ‚ö†Ô∏è –ü–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è: –í–∞–ª—ñ–¥—É–π—Ç–µ –≤–≤—ñ–¥ —É –ø—Ä–æ–¥–∞–∫—à–µ–Ω—ñ!
    if (!text || text.trim() === '') {
        return res.status(400).json({ error: '–¢–µ–∫—Å—Ç –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –æ–±–æ–≤\'—è–∑–∫–æ–≤–∏–π' });
    }
    
    const message = {
        id: messages.length + 1,
        user: user || '–ê–Ω–æ–Ω—ñ–º',
        text: text.trim(),
        timestamp: new Date().toISOString()
    };
    
    messages.push(message);
    console.log(`üí¨ –ù–æ–≤–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤—ñ–¥ ${message.user}: ${message.text}`);
    
    // üéì –ù–∞–≤—á–∞–ª—å–Ω–∏–π –∫–æ–º–µ–Ω—Ç–∞—Ä: –¶–µ –∫–ª—é—á–æ–≤–∏–π –º–æ–º–µ–Ω—Ç - —Å–ø–æ–≤—ñ—â–∞—î–º–æ –≤—Å—ñ—Ö –æ—á—ñ–∫—É—é—á–∏—Ö –∫–ª—ñ—î–Ω—Ç—ñ–≤!
    // –°–∞–º–µ —Ü–µ —Ä–æ–±–∏—Ç—å –¥–æ–≤–≥–µ –æ–ø–∏—Ç—É–≤–∞–Ω–Ω—è "—Ä–µ–∞–ª—å–Ω–∏–º —á–∞—Å–æ–º"
    console.log(`üîî –°–ø–æ–≤—ñ—â–∞—î–º–æ ${waitingClients.length} –æ—á—ñ–∫—É—é—á–∏—Ö –∫–ª—ñ—î–Ω—Ç—ñ–≤...`);
    
    waitingClients.forEach(client => {
        // üîß –¢–µ—Ö–Ω—ñ—á–Ω–∏–π –∫–æ–º–µ–Ω—Ç–∞—Ä: –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –Ω–æ–≤—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∫–æ–∂–Ω–æ–º—É –æ—á—ñ–∫—É—é—á–æ–º—É –∫–ª—ñ—î–Ω—Ç—É
        const newMessages = messages.filter(msg => msg.id > client.lastMessageId);
        
        try {
            client.response.json(newMessages);
            console.log(`‚úÖ –°–ø–æ–≤—ñ—Å—Ç–∏–ª–∏ –∫–ª—ñ—î–Ω—Ç–∞ –ø—Ä–æ ${newMessages.length} –Ω–æ–≤–∏—Ö –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å`);
        } catch (error) {
            // –ö–ª—ñ—î–Ω—Ç –º—ñ–≥ –≤—ñ–¥'—î–¥–Ω–∞—Ç–∏—Å—è
            console.log(`‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è —Å–ø–æ–≤—ñ—Å—Ç–∏—Ç–∏ –∫–ª—ñ—î–Ω—Ç–∞: ${error.message}`);
        }
    });
    
    // üîß –¢–µ—Ö–Ω—ñ—á–Ω–∏–π –∫–æ–º–µ–Ω—Ç–∞—Ä: –û—á–∏—â–∞—î–º–æ –º–∞—Å–∏–≤ –æ—á—ñ–∫—É—é—á–∏—Ö –∫–ª—ñ—î–Ω—Ç—ñ–≤
    waitingClients.length = 0;
    
    res.status(201).json({ success: true, message });
});

// üéì –ù–∞–≤—á–∞–ª—å–Ω–∏–π –∫–æ–º–µ–Ω—Ç–∞—Ä: –ï–Ω–¥–ø–æ—ñ–Ω—Ç –¥–ª—è –ø–æ–∫–∞–∑—É —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –¥–æ–≤–≥–æ–≥–æ –æ–ø–∏—Ç—É–≤–∞–Ω–Ω—è
app.get('/stats', (req, res) => {
    res.json({
        totalMessages: messages.length,
        waitingClients: waitingClients.length,
        oldestWaitingTime: waitingClients.length > 0 
            ? Math.floor((Date.now() - Math.min(...waitingClients.map(c => c.timestamp))) / 1000) + '—Å'
            : '–ù/–î'
    });
});

// üîß –¢–µ—Ö–Ω—ñ—á–Ω–∏–π –∫–æ–º–µ–Ω—Ç–∞—Ä: –ó–∞–ø—É—Å–∫–∞—î–º–æ —Å–µ—Ä–≤–µ—Ä
app.listen(PORT, () => {
    console.log(`üöÄ HTTP —Å–µ—Ä–≤–µ—Ä –¥–æ–≤–≥–æ–≥–æ –æ–ø–∏—Ç—É–≤–∞–Ω–Ω—è –ø—Ä–∞—Ü—é—î –Ω–∞ http://localhost:${PORT}`);
    console.log('üìù –ü—Ä–∏–∫–ª–∞–¥ 3: –°–µ—Ä–≤–µ—Ä —É—Ç—Ä–∏–º—É—î –∑–∞–ø–∏—Ç–∏, –¥–æ–∫–∏ –Ω–µ –ø—Ä–∏–π–¥—É—Ç—å –Ω–æ–≤—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è');
    console.log(`‚è±Ô∏è –¢–∞–π–º–∞—É—Ç –¥–æ–≤–≥–æ–≥–æ –æ–ø–∏—Ç—É–≤–∞–Ω–Ω—è: ${LONG_POLL_TIMEOUT / 1000} —Å–µ–∫—É–Ω–¥`);
    
    console.log('\n‚ú® –ü–µ—Ä–µ–≤–∞–≥–∏ –¥–æ–≤–≥–æ–≥–æ –æ–ø–∏—Ç—É–≤–∞–Ω–Ω—è:');
    console.log('   - –ú–∞–π–∂–µ –º–∏—Ç—Ç—î–≤—ñ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è (–Ω–µ–º–∞—î –∑–∞—Ç—Ä–∏–º–∫–∏ –æ–ø–∏—Ç—É–≤–∞–Ω–Ω—è)');
    console.log('   - –ù–∞–±–∞–≥–∞—Ç–æ –µ—Ñ–µ–∫—Ç–∏–≤–Ω—ñ—à–µ (–Ω–µ–º–∞—î –ø–æ—Ä–æ–∂–Ω—ñ—Ö –≤—ñ–¥–ø–æ–≤—ñ–¥–µ–π)');
    console.log('   - –ú–µ–Ω—à–µ –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä (–º–µ–Ω—à–µ –∑–∞–ø–∏—Ç—ñ–≤)');
    console.log('   - –í—Å–µ —â–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∏–π HTTP\n');
    
    console.log('‚ö†Ô∏è  –í–∏–∫–ª–∏–∫–∏ –¥–æ–≤–≥–æ–≥–æ –æ–ø–∏—Ç—É–≤–∞–Ω–Ω—è:');
    console.log('   - –°–∫–ª–∞–¥–Ω—ñ—à–∞ —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ');
    console.log('   - –ü–æ—Ç—Ä—ñ–±–Ω–µ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –∑\'—î–¥–Ω–∞–Ω–Ω—è–º–∏');
    console.log('   - –ú–æ–∂–µ –¥–æ—Å—è–≥—Ç–∏ –ª—ñ–º—ñ—Ç—ñ–≤ –∑\'—î–¥–Ω–∞–Ω—å');
    console.log('   - –ü–æ—Ç—Ä—ñ–±–Ω–∞ –ª–æ–≥—ñ–∫–∞ –ø–µ—Ä–µ–ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –Ω–∞ –∫–ª—ñ—î–Ω—Ç—ñ\n');
});

// üéì –ù–∞–≤—á–∞–ª—å–Ω–∏–π –∫–æ–º–µ–Ω—Ç–∞—Ä: –î–æ–≤–≥–µ –æ–ø–∏—Ç—É–≤–∞–Ω–Ω—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º—É —Å–≤—ñ—Ç—ñ:
// - –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞–ª–æ—Å—è –±–∞–≥–∞—Ç—å–º–∞ —á–∞—Ç-–∑–∞—Å—Ç–æ—Å—É–Ω–∫–∞–º–∏ –¥–æ WebSockets
// - Facebook —á–∞—Ç –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞–≤ –¥–æ–≤–≥–µ –æ–ø–∏—Ç—É–≤–∞–Ω–Ω—è —Ä–æ–∫–∞–º–∏
// - –í—Å–µ —â–µ –∫–æ—Ä–∏—Å–Ω–µ, –∫–æ–ª–∏ WebSockets –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ñ
// - –ì–∞—Ä–Ω–∏–π –∑–∞–ø–∞—Å–Ω–∏–π –≤–∞—Ä—ñ–∞–Ω—Ç –¥–ª—è –æ–±–º–µ–∂–µ–Ω—å —Ñ–∞–π—Ä–≤–æ–ª–∞

// ‚ö° –¶—ñ–∫–∞–≤–∏–π —Ñ–∞–∫—Ç: –î–æ–≤–≥–µ –æ–ø–∏—Ç—É–≤–∞–Ω–Ω—è —ñ–Ω–æ–¥—ñ –Ω–∞–∑–∏–≤–∞—é—Ç—å "Comet" –∞–±–æ
// "Reverse Ajax", —Ç–æ–º—É —â–æ —Å–µ—Ä–≤–µ—Ä "–ø—Ä–æ—à—Ç–æ–≤—Ö—É—î" –¥–∞–Ω—ñ –∫–ª—ñ—î–Ω—Ç—É!
